import boto3
import hashlib
from decimal import Decimal

dynamodb = boto3.resource('dynamodb')
table = dynamodb.Table('affective')

def put_link(url, scores, access_time):
    print('adding link to db')
    print(url, scores, access_time)
    try:
        # Hash the url to get an id
        hashed_url = hashlib.sha256(url.encode('utf-8')).hexdigest()
        # Todays date (days since 1970-01-01)
        date = int(access_time / 86400)
        key = f'LINK#{hashed_url}#{date}'

        # Add to database
        table.put_item(
            Item={
                'pk': key,
                'sk': key,
                'link': url,
                # Cast to Decimal to avoid boto3 error
                # casting the float to str is necessary to avoid "inexact" error
                'emotion': Decimal(str(scores['emotion'])),
                'usefulness': Decimal(str(scores['usefulness'])),
                'knowledge': Decimal(str(scores['knowledge']))
            }
        )

        return {
            'link': url,
            'scores': scores,
            'key': key,
        }
    except Exception as e:
        raise Exception(str(e))